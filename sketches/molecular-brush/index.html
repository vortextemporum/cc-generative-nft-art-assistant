<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Molecular Brush</title>
  <script src="lib/p5.min.js"></script>
  <script src="lib/p5.brush.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #0d0d14;
      color: #e0e0e0;
      font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
      font-size: 12px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    header { text-align: center; margin-bottom: 20px; }
    h1 { font-size: 1.5rem; font-weight: 400; letter-spacing: 0.2em; color: #fff; margin-bottom: 4px; }
    .subtitle { color: #666; font-size: 11px; }
    main { display: flex; gap: 20px; max-width: 1000px; justify-content: center; flex-wrap: wrap; }

    .canvas-container {
      background: #000;
      border: 1px solid #222;
      border-radius: 8px;
      overflow: visible;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 720px;
      min-height: 720px;
    }
    #sketch-holder { display: block; }
    #sketch-holder canvas { display: block; }

    .progress-overlay {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      color: #888; font-size: 12px;
    }
    .progress-overlay.hidden { display: none; }

    .features-panel {
      background: #111118;
      border: 1px solid #222;
      border-radius: 8px;
      padding: 16px;
      width: 260px;
    }
    .version-select {
      width: 100%;
      background: #1a1a24;
      border: 1px solid #333;
      color: #e0e0e0;
      padding: 8px 10px;
      border-radius: 6px;
      font-family: inherit;
      font-size: 11px;
      margin-bottom: 14px;
      cursor: pointer;
    }
    .version-select:hover { border-color: #444; }
    .panel-title {
      font-size: 11px; font-weight: 600; letter-spacing: 0.15em; color: #888;
      margin-bottom: 14px; text-transform: uppercase;
      border-bottom: 1px solid #222; padding-bottom: 8px;
    }
    .features-table { width: 100%; border-collapse: collapse; font-size: 11px; }
    .features-table td { padding: 6px 0; border-bottom: 1px solid #1a1a24; }
    .features-table td:first-child { color: #666; width: 70px; }
    .features-table td:nth-child(2) { color: #ddd; }
    .features-table td:last-child { text-align: right; }
    .rarity-badge { font-size: 9px; padding: 2px 6px; border-radius: 8px; text-transform: uppercase; font-weight: 600; }
    .rarity-common { background: #222; color: #777; }
    .rarity-uncommon { background: rgba(76, 175, 80, 0.15); color: #66bb6a; }
    .rarity-rare { background: rgba(33, 150, 243, 0.15); color: #42a5f5; }
    .rarity-legendary { background: rgba(255, 193, 7, 0.15); color: #ffca28; }
    .color-swatches { display: flex; gap: 3px; margin-top: 4px; }
    .swatch { width: 14px; height: 14px; border-radius: 2px; border: 1px solid rgba(255,255,255,0.1); }

    .controls { display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap; }
    button {
      background: #1a1a24; border: 1px solid #333; color: #e0e0e0;
      padding: 8px 14px; border-radius: 6px; font-family: inherit; font-size: 11px; cursor: pointer;
    }
    button:hover { background: #252535; border-color: #444; }
    button.primary { background: linear-gradient(135deg, #667eea, #764ba2); border: none; color: white; }
    button.primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
    .hash-display {
      font-size: 10px; color: #4ecdc4; background: rgba(78, 205, 196, 0.08);
      border: 1px solid rgba(78, 205, 196, 0.15); padding: 8px 10px;
      border-radius: 6px; word-break: break-all; margin-top: 12px;
    }
    .shortcuts { font-size: 10px; color: #555; margin-top: 12px; }
    .shortcuts kbd { background: #1a1a24; padding: 2px 5px; border-radius: 3px; margin: 0 2px; }

    .batch-progress { margin-top: 12px; }
    .batch-bar { height: 6px; background: #1a1a24; border-radius: 3px; overflow: hidden; margin-bottom: 6px; }
    .batch-fill { height: 100%; background: linear-gradient(135deg, #667eea, #764ba2); width: 0%; transition: width 0.3s; }
    #batch-text { font-size: 10px; color: #888; }

    .note { font-size: 10px; color: #555; margin-bottom: 14px; }
    .note a { color: #667eea; text-decoration: none; }
    .note a:hover { text-decoration: underline; }

    /* Rarity Curves */
    .rarity-section { margin-top: 16px; border-top: 1px solid #222; padding-top: 14px; }
    .rarity-curve { margin-bottom: 10px; }
    .rarity-curve-label { font-size: 10px; color: #666; margin-bottom: 4px; display: flex; justify-content: space-between; }
    .rarity-curve-bar { height: 8px; background: #1a1a24; border-radius: 4px; overflow: hidden; display: flex; }
    .rarity-segment { height: 100%; transition: width 0.3s; }
    .rarity-segment.common { background: #444; }
    .rarity-segment.uncommon { background: #66bb6a; }
    .rarity-segment.rare { background: #42a5f5; }
    .rarity-segment.legendary { background: #ffca28; }
    .rarity-legend { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    .rarity-legend-item { display: flex; align-items: center; gap: 4px; font-size: 9px; color: #666; }
    .rarity-legend-dot { width: 8px; height: 8px; border-radius: 2px; }
  </style>
</head>
<body>
  <header>
    <h1>MOLECULAR BRUSH</h1>
    <p class="subtitle">p5.brush flow fields with molecular physics</p>
  </header>

  <main>
    <div class="canvas-container">
      <div id="sketch-holder"></div>
      <div class="progress-overlay" id="progress-overlay">
        <span>Rendering...</span>
      </div>
    </div>

    <div class="features-panel">
      <select id="version-select" class="version-select">
        <option value="sketch.js">v2.7.1 - Rarity Curves (current)</option>
        <option value="versions/v2.7.0-aspect.js">v2.7.0 - Variable Aspect Ratios</option>
        <option value="versions/v2.6.2-framed.js">v2.6.2 - Thin Frames</option>
        <option value="versions/v2.6.1-framed.js">v2.6.1 - Framed</option>
        <option value="versions/v2.6.0-framed.js">v2.6.0 - Framed</option>
        <option value="versions/v2.5.0-fast.js">v2.5.0 - Fast</option>
        <option value="versions/v2.4.1-fast.js">v2.4.1 - Fast</option>
        <option value="versions/v2.3.1-fast.js">v2.3.1 - Fast</option>
        <option value="versions/v2.2.0-fast.js">v2.2.0 - Fast</option>
        <option value="versions/v2.0.0-static.js">v2.0.0 - Static</option>
      </select>
      <div class="note">v1.x versions moved to <a href="../molecular-watercolor/">Molecular Watercolor</a></div>
      <div class="panel-title">Features</div>
      <table class="features-table">
        <tbody id="features-body">
          <tr><td colspan="3">Loading...</td></tr>
        </tbody>
      </table>

      <div class="rarity-section">
        <div class="panel-title">Rarity Distribution</div>
        <div id="rarity-curves"></div>
        <div class="rarity-legend">
          <div class="rarity-legend-item"><div class="rarity-legend-dot" style="background:#444"></div>Common</div>
          <div class="rarity-legend-item"><div class="rarity-legend-dot" style="background:#66bb6a"></div>Uncommon</div>
          <div class="rarity-legend-item"><div class="rarity-legend-dot" style="background:#42a5f5"></div>Rare</div>
          <div class="rarity-legend-item"><div class="rarity-legend-dot" style="background:#ffca28"></div>Legendary</div>
        </div>
      </div>

      <div class="controls">
        <button id="btn-regenerate" class="primary">New Hash (R)</button>
        <button id="btn-save">Save PNG (S)</button>
        <button id="btn-batch">Export 20 (B)</button>
      </div>

      <div id="batch-progress" class="batch-progress" style="display: none;">
        <div class="batch-bar"><div class="batch-fill" id="batch-fill"></div></div>
        <span id="batch-text">Exporting...</span>
      </div>

      <div class="hash-display" id="hash-display">0x...</div>
      <div class="shortcuts"><kbd>R</kbd> regenerate <kbd>S</kbd> save <kbd>B</kbd> batch export 20</div>
    </div>
  </main>

  <script>
    const progressOverlay = document.getElementById('progress-overlay');
    const hashDisplay = document.getElementById('hash-display');
    const featuresBody = document.getElementById('features-body');

    window.onFeaturesGenerated = function(features) {
      hashDisplay.textContent = features.hash;
      updateFeaturesTable(features);
      updateRarityCurves(features);
      progressOverlay.classList.add('hidden');
    };

    window.onRenderStart = function() {
      progressOverlay.classList.remove('hidden');
    };

    window.onRenderComplete = function() {
      progressOverlay.classList.add('hidden');
    };

    function updateFeaturesTable(features) {
      const rows = [];

      if (features.palette) {
        rows.push({ name: 'Palette', value: features.palette.name, rarity: features.palette.rarity, colors: features.palette.colors });
      }
      if (features.flow) {
        rows.push({ name: 'Flow', value: features.flow.style, rarity: features.flow.rarity });
      }
      if (features.density) {
        const densityVal = features.density.name || (features.density.count + ' molecules');
        rows.push({ name: 'Density', value: densityVal, rarity: features.density.rarity });
      }
      if (features.brush) {
        rows.push({ name: 'Brush', value: features.brush.style, rarity: features.brush.rarity });
      }
      if (features.strokes) {
        rows.push({ name: 'Strokes', value: features.strokes.name, rarity: features.strokes.rarity });
      }
      if (features.trail) {
        rows.push({ name: 'Trail', value: features.trail.name, rarity: features.trail.rarity });
      }
      if (features.bleed) {
        rows.push({ name: 'Bleed', value: features.bleed.name, rarity: features.bleed.rarity });
      }
      if (features.drops) {
        rows.push({ name: 'Drops', value: features.drops.name, rarity: features.drops.rarity });
      }
      if (features.frame) {
        const frameVal = features.frame.style === 'none' ? 'None' : features.frame.style + ' (' + features.frame.color + ')';
        rows.push({ name: 'Frame', value: frameVal, rarity: features.frame.rarity });
      }
      if (features.aspectRatio) {
        rows.push({ name: 'Aspect', value: features.aspectRatio.displayName, rarity: features.aspectRatio.rarity });
      }
      if (features.paper) {
        rows.push({ name: 'Paper', value: features.paper.tone, rarity: 'common' });
      }
      if (features.composition) {
        rows.push({ name: 'Layout', value: features.composition, rarity: 'common' });
      }

      featuresBody.innerHTML = rows.map(row => {
        let valueHtml = row.value.charAt(0).toUpperCase() + row.value.slice(1);
        if (row.colors) {
          valueHtml += '<div class="color-swatches">' +
            row.colors.map(c => `<div class="swatch" style="background:rgb(${c[0]},${c[1]},${c[2]})"></div>`).join('') +
            '</div>';
        }
        return `<tr>
          <td>${row.name}</td>
          <td>${valueHtml}</td>
          <td><span class="rarity-badge rarity-${row.rarity}">${row.rarity}</span></td>
        </tr>`;
      }).join('');
    }

    // Rarity distribution percentages (from rollRarity calls in sketch.js)
    const rarityDistributions = {
      palette:   { common: 40, uncommon: 35, rare: 20, legendary: 5 },
      flow:      { common: 40, uncommon: 30, rare: 20, legendary: 10 },
      density:   { common: 50, uncommon: 30, rare: 15, legendary: 5 },
      brush:     { common: 40, uncommon: 35, rare: 18, legendary: 7 },
      strokes:   { common: 30, uncommon: 30, rare: 25, legendary: 15 },
      bleed:     { common: 40, uncommon: 35, rare: 18, legendary: 7 },
      drops:     { common: 35, uncommon: 30, rare: 25, legendary: 10 },
      trail:     { common: 45, uncommon: 30, rare: 18, legendary: 7 },
      frame:     { common: 40, uncommon: 35, rare: 20, legendary: 5 },
      aspect:    { common: 35, uncommon: 35, rare: 22, legendary: 8 },
    };

    function updateRarityCurves(features) {
      const container = document.getElementById('rarity-curves');
      const traits = [
        { key: 'palette', label: 'Palette', current: features.palette?.rarity },
        { key: 'flow', label: 'Flow', current: features.flow?.rarity },
        { key: 'brush', label: 'Brush', current: features.brush?.rarity },
        { key: 'strokes', label: 'Strokes', current: features.strokes?.rarity },
        { key: 'bleed', label: 'Bleed', current: features.bleed?.rarity },
        { key: 'drops', label: 'Drops', current: features.drops?.rarity },
        { key: 'frame', label: 'Frame', current: features.frame?.rarity },
        { key: 'aspect', label: 'Aspect', current: features.aspectRatio?.rarity },
      ];

      container.innerHTML = traits.map(trait => {
        const dist = rarityDistributions[trait.key] || { common: 50, uncommon: 30, rare: 15, legendary: 5 };
        const current = trait.current || 'common';
        return `
          <div class="rarity-curve">
            <div class="rarity-curve-label">
              <span>${trait.label}</span>
              <span class="rarity-badge rarity-${current}" style="font-size:8px">${current}</span>
            </div>
            <div class="rarity-curve-bar">
              <div class="rarity-segment common" style="width:${dist.common}%"></div>
              <div class="rarity-segment uncommon" style="width:${dist.uncommon}%"></div>
              <div class="rarity-segment rare" style="width:${dist.rare}%"></div>
              <div class="rarity-segment legendary" style="width:${dist.legendary}%"></div>
            </div>
          </div>
        `;
      }).join('');
    }

    document.getElementById('btn-regenerate').addEventListener('click', () => {
      if (window.regenerate) window.regenerate();
    });

    document.getElementById('btn-save').addEventListener('click', () => {
      const features = window.getFeatures ? window.getFeatures() : { hash: 'unknown' };
      saveCanvas('molecular-brush-' + features.hash.slice(2, 10), 'png');
    });

    // Batch export button
    const batchBtn = document.getElementById('btn-batch');
    const batchProgressEl = document.getElementById('batch-progress');
    const batchFill = document.getElementById('batch-fill');
    const batchText = document.getElementById('batch-text');

    batchBtn.addEventListener('click', async () => {
      if (window.isBatchExporting && window.isBatchExporting()) return;

      batchBtn.disabled = true;
      batchBtn.textContent = 'Exporting...';
      batchProgressEl.style.display = 'block';

      // Start batch export
      if (window.batchExport) {
        await window.batchExport(20, 600);
      }

      batchBtn.disabled = false;
      batchBtn.textContent = 'Export 20 (B)';
      batchProgressEl.style.display = 'none';
    });

    // Update batch progress bar
    setInterval(() => {
      if (window.isBatchExporting && window.isBatchExporting()) {
        const progress = window.getBatchProgress ? window.getBatchProgress() : 0;
        batchFill.style.width = (progress * 100) + '%';
        batchText.textContent = `Exporting... ${Math.round(progress * 100)}%`;
      }
    }, 100);

    window.onBatchExportComplete = function(count) {
      batchFill.style.width = '100%';
      batchText.textContent = `Done! ${count} images saved`;
      setTimeout(() => {
        batchProgressEl.style.display = 'none';
        batchFill.style.width = '0%';
      }, 2000);
    };

    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
      if (e.key.toLowerCase() === 'r') {
        if (window.regenerate) window.regenerate();
      } else if (e.key.toLowerCase() === 's') {
        e.preventDefault();
        const features = window.getFeatures ? window.getFeatures() : { hash: 'unknown' };
        saveCanvas('molecular-brush-' + features.hash.slice(2, 10), 'png');
      } else if (e.key.toLowerCase() === 'b') {
        e.preventDefault();
        batchBtn.click();
      }
    });

    // Version selector
    const versionSelect = document.getElementById('version-select');
    const urlParams = new URLSearchParams(window.location.search);
    const currentVersion = urlParams.get('version') || 'sketch.js';

    // Set dropdown to current version
    for (let opt of versionSelect.options) {
      if (opt.value === currentVersion) {
        opt.selected = true;
        break;
      }
    }

    versionSelect.addEventListener('change', (e) => {
      const version = e.target.value;
      if (version === 'sketch.js') {
        window.location.href = window.location.pathname;
      } else {
        window.location.href = window.location.pathname + '?version=' + encodeURIComponent(version);
      }
    });
  </script>
  <script>
    // Load version from URL param or default
    (function() {
      const urlParams = new URLSearchParams(window.location.search);
      const sketchSrc = urlParams.get('version') || 'sketch.js';
      document.write('<script src="' + sketchSrc + '"><\/script>');
    })();
  </script>
</body>
</html>
