<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Graphical Score - Generative</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #0d0d14;
      color: #e0e0e0;
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    header {
      width: 100%;
      max-width: 1400px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #2a2a3a;
    }

    h1 {
      font-size: 1.4rem;
      font-weight: 400;
      color: #fff;
    }

    .version {
      font-size: 0.75rem;
      color: #666;
      margin-left: 10px;
    }

    .controls {
      display: flex;
      gap: 10px;
    }

    button {
      background: #1a1a2e;
      border: 1px solid #3a3a5a;
      color: #e0e0e0;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    button:hover {
      background: #2a2a4e;
      border-color: #5a5a8a;
    }

    .main-container {
      display: flex;
      gap: 20px;
      max-width: 1400px;
      width: 100%;
    }

    .canvas-section {
      flex: 1;
    }

    #sketch-holder {
      background: #1a1a2e;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    #sketch-holder canvas {
      display: block;
    }

    .sidebar {
      width: 320px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .panel {
      background: #1a1a2e;
      border-radius: 8px;
      padding: 15px;
      border: 1px solid #2a2a3a;
    }

    .panel h2 {
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 12px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel h2 button {
      padding: 4px 8px;
      font-size: 0.7rem;
    }

    .hash-display {
      font-size: 0.7rem;
      color: #666;
      word-break: break-all;
      background: #0d0d14;
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 10px;
    }

    .feature-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid #2a2a3a;
      font-size: 0.85rem;
    }

    .feature-row:last-child {
      border-bottom: none;
    }

    .feature-name {
      color: #888;
    }

    .feature-value {
      color: #fff;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .rarity-badge {
      font-size: 0.65rem;
      padding: 2px 6px;
      border-radius: 3px;
      text-transform: uppercase;
      font-weight: 500;
    }

    .rarity-common { background: #3a3a4a; color: #aaa; }
    .rarity-uncommon { background: #2a4a3a; color: #4a9; }
    .rarity-rare { background: #3a3a6a; color: #88f; }
    .rarity-legendary { background: #5a3a2a; color: #fa4; }

    .stats-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }

    .stat-chip {
      background: #0d0d14;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      color: #888;
    }

    .slider-group {
      margin-bottom: 12px;
    }

    .slider-group label {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: #888;
      margin-bottom: 4px;
    }

    .slider-group input[type="range"] {
      width: 100%;
      height: 4px;
      -webkit-appearance: none;
      background: #3a3a5a;
      border-radius: 2px;
      outline: none;
    }

    .slider-group input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      background: #fff;
      border-radius: 50%;
      cursor: pointer;
    }

    .slider-group select {
      width: 100%;
      background: #0d0d14;
      border: 1px solid #3a3a5a;
      color: #e0e0e0;
      padding: 6px;
      border-radius: 4px;
      font-family: inherit;
      font-size: 0.85rem;
    }

    .rarity-bar {
      height: 20px;
      display: flex;
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 5px;
    }

    .rarity-segment {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6rem;
      color: rgba(255,255,255,0.7);
    }

    .rarity-segment.common { background: #3a3a4a; }
    .rarity-segment.uncommon { background: #2a4a3a; }
    .rarity-segment.rare { background: #3a3a6a; }
    .rarity-segment.legendary { background: #5a3a2a; }
    .rarity-segment.current {
      outline: 2px solid #fff;
      outline-offset: -2px;
    }

    .rarity-curve-row {
      margin-bottom: 12px;
    }

    .rarity-curve-label {
      font-size: 0.75rem;
      color: #888;
      margin-bottom: 4px;
    }

    .feedback-panel {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .feedback-panel button {
      flex: 1;
    }

    .feedback-panel .like { background: #2a4a3a; border-color: #4a8a6a; }
    .feedback-panel .like:hover { background: #3a5a4a; }
    .feedback-panel .dislike { background: #4a2a2a; border-color: #8a4a4a; }
    .feedback-panel .dislike:hover { background: #5a3a3a; }

    .keyboard-hints {
      font-size: 0.75rem;
      color: #555;
      text-align: center;
      margin-top: 15px;
    }

    .keyboard-hints kbd {
      background: #2a2a3a;
      padding: 2px 6px;
      border-radius: 3px;
      margin: 0 2px;
    }

    @media (max-width: 1200px) {
      .main-container {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        flex-direction: row;
        flex-wrap: wrap;
      }
      .panel {
        flex: 1;
        min-width: 280px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Graphical Score <span class="version">v1.0.0</span></h1>
    </div>
    <div class="controls">
      <button id="btn-regenerate">Regenerate (R)</button>
      <button id="btn-save">Save PNG (S)</button>
    </div>
  </header>

  <div class="main-container">
    <div class="canvas-section">
      <div id="sketch-holder"></div>
    </div>

    <div class="sidebar">
      <!-- Features Panel -->
      <div class="panel" id="features-panel">
        <h2>Features</h2>
        <div class="hash-display" id="hash-display"></div>
        <div id="features-list"></div>
      </div>

      <!-- Parameters Panel -->
      <div class="panel" id="params-panel">
        <h2>Parameters <button id="btn-reset">Reset</button></h2>
        <div id="params-list"></div>
      </div>

      <!-- Rarity Curves Panel -->
      <div class="panel" id="rarity-panel">
        <h2>Rarity Curves</h2>
        <div id="rarity-curves"></div>
      </div>

      <!-- Feedback Panel -->
      <div class="panel" id="feedback-panel">
        <h2>Feedback</h2>
        <div class="stats-summary" id="feedback-stats"></div>
        <div class="feedback-panel">
          <button class="like" id="btn-like">Like (L)</button>
          <button class="dislike" id="btn-dislike">Dislike (D)</button>
        </div>
        <button id="btn-export" style="width: 100%; margin-top: 10px;">Export to Console</button>
      </div>
    </div>
  </div>

  <div class="keyboard-hints">
    <kbd>R</kbd> Regenerate &nbsp;
    <kbd>S</kbd> Save PNG &nbsp;
    <kbd>L</kbd> Like &nbsp;
    <kbd>D</kbd> Dislike
  </div>

  <script src="sketch.js"></script>
  <script>
    // Feedback system
    const FEEDBACK_KEY = 'graphical-score-feedback';

    function loadFeedback() {
      const data = localStorage.getItem(FEEDBACK_KEY);
      return data ? JSON.parse(data) : { liked: [], disliked: [] };
    }

    function saveFeedback(feedback) {
      localStorage.setItem(FEEDBACK_KEY, JSON.stringify(feedback));
    }

    function recordFeedback(isLike) {
      const feedback = loadFeedback();
      const features = window.getFeatures();
      const entry = {
        timestamp: Date.now(),
        hash: window.getHash(),
        features: { ...features },
        hadOverrides: window.hasModifications()
      };

      if (isLike) {
        feedback.liked.push(entry);
        console.log('LIKED:', entry);
      } else {
        feedback.disliked.push(entry);
        console.log('DISLIKED:', entry);
      }

      saveFeedback(feedback);
      updateFeedbackStats();
    }

    function updateFeedbackStats() {
      const feedback = loadFeedback();
      const statsEl = document.getElementById('feedback-stats');
      statsEl.innerHTML = `
        <span class="stat-chip">Liked: ${feedback.liked.length}</span>
        <span class="stat-chip">Disliked: ${feedback.disliked.length}</span>
      `;
    }

    function exportFeedback() {
      const feedback = loadFeedback();
      console.log('=== FEEDBACK EXPORT ===');
      console.log(JSON.stringify(feedback, null, 2));
      console.log('=== END EXPORT ===');
      return feedback;
    }

    // UI Update functions
    function updateFeaturesPanel() {
      const features = window.getFeatures();
      const hashEl = document.getElementById('hash-display');
      const listEl = document.getElementById('features-list');

      hashEl.textContent = window.getHash();

      const displayFeatures = [
        { name: 'Style', value: features.pureStyleType ? `Pure ${features.pureStyleType}` : features.style, rarity: features.styleRarity },
        { name: 'Voices', value: features.voiceCount, rarity: features.voiceRarity },
        { name: 'Structure', value: features.structure, rarity: features.structureRarity },
        { name: 'Density', value: features.density, rarity: features.densityRarity },
        { name: 'Contrast', value: features.contrast, rarity: features.contrastRarity },
        { name: 'Palette', value: features.paletteName },
        { name: 'Tempo', value: features.tempo },
        { name: 'Time Sig', value: features.timeSignature },
        { name: 'Micropolyphony', value: features.hasMicropolyphony ? 'Yes' : 'No' },
        { name: 'Glissandi', value: features.hasGlissandi ? 'Yes' : 'No' },
        { name: 'Symmetry', value: features.hasSymmetry ? 'Palindrome' : 'None' }
      ];

      listEl.innerHTML = displayFeatures.map(f => `
        <div class="feature-row">
          <span class="feature-name">${f.name}</span>
          <span class="feature-value">
            ${f.value}
            ${f.rarity ? `<span class="rarity-badge rarity-${f.rarity}">${f.rarity}</span>` : ''}
          </span>
        </div>
      `).join('');
    }

    function updateRarityCurves() {
      const curves = window.getRarityCurves();
      const features = window.getFeatures();
      const container = document.getElementById('rarity-curves');

      const curvesToShow = ['style', 'voiceCount', 'structure', 'density', 'contrast'];

      container.innerHTML = curvesToShow.map(key => {
        const curve = curves[key];
        if (!curve) return '';

        // Determine current selection
        let currentIndex = 0;
        const currentRarity = features[key + 'Rarity'];
        if (currentRarity === 'uncommon') currentIndex = 1;
        else if (currentRarity === 'rare') currentIndex = 2;
        else if (currentRarity === 'legendary') currentIndex = 3;

        const rarityClasses = ['common', 'uncommon', 'rare', 'legendary'];

        return `
          <div class="rarity-curve-row">
            <div class="rarity-curve-label">${key}</div>
            <div class="rarity-bar">
              ${curve.probabilities.map((p, i) => `
                <div class="rarity-segment ${rarityClasses[i]} ${i === currentIndex ? 'current' : ''}"
                     style="width: ${p * 100}%">
                  ${p >= 0.1 ? Math.round(p * 100) + '%' : ''}
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    function setupParameterControls() {
      const container = document.getElementById('params-list');
      const features = window.getFeatures();

      // Discrete parameters
      const discreteParams = [
        {
          name: 'paletteName',
          label: 'Palette',
          options: ['sepia', 'manuscript', 'parchment', 'aged', 'blueprintFaded']
        }
      ];

      // Continuous parameters
      const continuousParams = [
        { name: 'densityValue', label: 'Density', min: 0.05, max: 0.95, step: 0.05 },
        { name: 'contrastValue', label: 'Contrast', min: 0.1, max: 1.0, step: 0.05 },
        { name: 'lineWeight', label: 'Line Weight', min: 0.3, max: 3.0, step: 0.1 },
        { name: 'noiseScale', label: 'Noise Scale', min: 0.001, max: 0.01, step: 0.001 }
      ];

      let html = '';

      // Discrete controls
      discreteParams.forEach(p => {
        html += `
          <div class="slider-group">
            <label>${p.label}</label>
            <select id="param-${p.name}" data-param="${p.name}">
              ${p.options.map(opt => `
                <option value="${opt}" ${features[p.name] === opt ? 'selected' : ''}>${opt}</option>
              `).join('')}
            </select>
          </div>
        `;
      });

      // Continuous controls
      continuousParams.forEach(p => {
        const value = features[p.name] || p.min;
        html += `
          <div class="slider-group">
            <label>
              <span>${p.label}</span>
              <span id="val-${p.name}">${value.toFixed(2)}</span>
            </label>
            <input type="range" id="param-${p.name}" data-param="${p.name}"
                   min="${p.min}" max="${p.max}" step="${p.step}" value="${value}">
          </div>
        `;
      });

      container.innerHTML = html;

      // Add event listeners
      discreteParams.forEach(p => {
        document.getElementById(`param-${p.name}`).addEventListener('change', (e) => {
          window.setParameter(p.name, e.target.value);
          // Update palette object
          if (p.name === 'paletteName') {
            const palettes = {
              sepia: { paper: "#f4efe4", paperDark: "#e8e0cf", ink: "#2a1f14", inkLight: "#5c4a3a", accent: "#8b4513", faded: "#9c8b7a" },
              blueprintFaded: { paper: "#e8eef4", paperDark: "#d4dde8", ink: "#1a2f4a", inkLight: "#4a6080", accent: "#2f5070", faded: "#8090a0" },
              manuscript: { paper: "#f5f0e1", paperDark: "#e5dcc8", ink: "#1a1a1a", inkLight: "#4a4a4a", accent: "#6b3a3a", faded: "#8a8070" },
              parchment: { paper: "#f2e8d5", paperDark: "#e0d4be", ink: "#3a2a1a", inkLight: "#6a5a4a", accent: "#7a4a2a", faded: "#a09080" },
              aged: { paper: "#ebe3d3", paperDark: "#d8ccb8", ink: "#2f2218", inkLight: "#5f5040", accent: "#704820", faded: "#907860" }
            };
            window.setParameter('palette', palettes[e.target.value]);
          }
          redrawSketch();
        });
      });

      continuousParams.forEach(p => {
        document.getElementById(`param-${p.name}`).addEventListener('input', (e) => {
          const val = parseFloat(e.target.value);
          document.getElementById(`val-${p.name}`).textContent = val.toFixed(2);
          window.setParameter(p.name, val);
          redrawSketch();
        });
      });
    }

    function redrawSketch() {
      // Trigger redraw
      if (typeof redraw === 'function') {
        redraw();
      }
    }

    // Event listeners
    document.getElementById('btn-regenerate').addEventListener('click', () => {
      window.regenerate();
    });

    document.getElementById('btn-save').addEventListener('click', () => {
      const features = window.getFeatures();
      saveCanvas(`graphical-score-${features.seed}`, 'png');
    });

    document.getElementById('btn-reset').addEventListener('click', () => {
      window.resetToOriginal();
      setupParameterControls();
      redrawSketch();
    });

    document.getElementById('btn-like').addEventListener('click', () => recordFeedback(true));
    document.getElementById('btn-dislike').addEventListener('click', () => recordFeedback(false));
    document.getElementById('btn-export').addEventListener('click', exportFeedback);

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;

      if (e.key === 'l' || e.key === 'L') {
        recordFeedback(true);
      } else if (e.key === 'd' || e.key === 'D') {
        recordFeedback(false);
      }
    });

    // Listen for feature updates
    window.addEventListener('featuresUpdated', () => {
      updateFeaturesPanel();
      updateRarityCurves();
      setupParameterControls();
    });

    // Initial setup after p5 loads
    window.addEventListener('load', () => {
      setTimeout(() => {
        updateFeaturesPanel();
        updateRarityCurves();
        setupParameterControls();
        updateFeedbackStats();
      }, 100);
    });
  </script>
</body>
</html>
