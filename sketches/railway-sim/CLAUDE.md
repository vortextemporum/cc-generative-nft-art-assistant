# Railway Sim - AI Assistant Guide

## Project Overview

Railway Sim is an interactive top-down railway simulation with procedural track networks, multiple train types, and full user control. Built with p5.js, it combines generative art principles with game-like interactivity.

**Core Concept:** Each hash generates a unique railway network with different topology, environment, train types, and color palette. Users can drive trains, control switches, and dispatch new trains.

## File Structure

```
railway-sim/
├── index.html          # Viewer with full control panel
├── sketch.js           # Main simulation (850+ lines)
├── CLAUDE.md           # This file
├── README.md           # User documentation
├── CHANGELOG.md        # Version history
├── versions/           # Archived versions
│   └── .gitkeep
└── docs/
    ├── FEATURES.md     # Feature/rarity documentation
    └── TECHNICAL.md    # Technical implementation
```

## Current Version: 1.0.0

## Key Concepts

### Network Generation
- **Node placement:** Relaxation algorithm for even distribution
- **Connectivity:** Minimum spanning tree ensures all nodes connected
- **Loop creation:** Additional edges based on `loopProb` parameter
- **Lines:** Tracks assigned to colored lines for visual distinction

### Train System
- **Types:** diesel, electric, steam, bullet, freight (different speeds/rarities)
- **Physics:** Simple arcade model with acceleration curves
- **Track following:** Position 0-1 along current track, transitions at nodes
- **Collision:** Distance-based detection, crash effect with reset

### Switch Logic
- **Detection:** Nodes with 3+ connections become switches
- **State:** Cycles through available exit routes
- **Interaction:** Click to toggle, train follows active route

### Environment System
- **Types:** urban, rural, coastal, mountain, industrial
- **Scenery:** Trees, buildings, factories, mountains, water
- **Weather:** None, rain, fog, night overlays

## Quick Commands

```bash
# Open in browser
open index.html

# Archive before changes
cp sketch.js versions/v1.0.0-sketch.js
```

## Making Changes

### Before Any Edit
1. Read current sketch.js to understand state
2. Archive current version if significant change planned
3. Increment version in file header

### Key Functions to Modify

| Function | Purpose |
|----------|---------|
| `generateFeatures()` | Hash-derived parameters |
| `generateNetwork()` | Track topology |
| `generateTrains()` | Initial train spawning |
| `Train.update()` | Movement physics |
| `Train.transitionToNextTrack()` | Junction handling |
| `drawTracks()` | Track rendering |
| `drawScenery()` | Environment elements |

### Adding New Train Types
1. Add to `TRAIN_TYPES` object with speed/accel/rarity
2. Add visual drawing code in `Train.draw()`
3. Update `rollRarity` calls in `generateTrains()` and `dispatchTrain()`

### Adding New Environments
1. Add to `ENVIRONMENTS` object with feature flags
2. Add scenery generation in `generateScenery()`
3. Add drawing code in `drawScenery()` switch

## Version Numbering

- **Major (2.0.0):** Changes that alter hash→output mapping
- **Minor (1.1.0):** New features, backward compatible
- **Patch (1.0.1):** Bug fixes, no visual changes

## p5.js Notes

- Using instance mode would require refactoring all global p5 functions
- `colorMode(HSB, 360, 100, 100, 1)` for all color work
- Canvas is 700x700, can be changed in `setup()`

## Known Limitations

- No pathfinding for AI trains (follow switch states)
- Signals are decorative only (no actual blocking)
- No save/load for network state
- Single-segment tracks only (no curves)

## Future Ideas

- Curved track segments using bezier
- AI train dispatching with destinations
- Working signal system with blocking
- Time tables and scheduling
- Multiple network layers (underground/surface)


<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

*No recent activity*
</claude-mem-context>