<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feynman Strings</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #0d0d14;
      color: #e0e0e0;
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    .container {
      display: flex;
      gap: 30px;
      max-width: 1400px;
    }

    .main-panel {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    #sketch-holder {
      background: #1a1a24;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }

    #sketch-holder canvas {
      display: block;
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      background: #2a2a3a;
      border: 1px solid #3a3a4a;
      color: #e0e0e0;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-family: inherit;
      font-size: 13px;
      transition: all 0.2s;
    }

    button:hover {
      background: #3a3a4a;
      border-color: #5a5a6a;
    }

    button.primary {
      background: #4a4a6a;
      border-color: #6a6aaa;
    }

    button.random {
      background: #6a4a6a;
      border-color: #aa6aaa;
    }

    button.random:hover {
      background: #8a5a8a;
    }

    button.like {
      background: #2a4a2a;
      border-color: #4a8a4a;
    }

    button.like:hover {
      background: #3a6a3a;
    }

    button.dislike {
      background: #4a2a2a;
      border-color: #8a4a4a;
    }

    button.dislike:hover {
      background: #6a3a3a;
    }

    .hash-display {
      font-size: 11px;
      color: #888;
      word-break: break-all;
      background: #1a1a24;
      padding: 8px 12px;
      border-radius: 4px;
    }

    .side-panel {
      width: 340px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
    }

    .panel {
      background: #1a1a24;
      border-radius: 8px;
      padding: 15px;
    }

    .panel h2 {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #888;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel h2 button {
      padding: 4px 10px;
      font-size: 11px;
    }

    /* Features Table */
    .features-table {
      width: 100%;
      font-size: 12px;
    }

    .feature-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid #2a2a3a;
    }

    .feature-row:last-child {
      border-bottom: none;
    }

    .feature-name {
      color: #888;
    }

    .feature-value {
      color: #e0e0e0;
      font-weight: 500;
    }

    .rarity-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .rarity-common { background: #3a3a4a; color: #aaa; }
    .rarity-uncommon { background: #2a4a3a; color: #4a9; }
    .rarity-rare { background: #3a3a6a; color: #88f; }
    .rarity-legendary { background: #5a3a2a; color: #fa4; }

    .mode-tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 11px;
      margin: 2px;
    }

    .mode-tag.qed { background: #f1c40f33; color: #f1c40f; }
    .mode-tag.qcd { background: #e6394633; color: #e63946; }
    .mode-tag.string { background: #74b9ff33; color: #74b9ff; }
    .mode-tag.vacuum { background: #63696733; color: #b2bec3; }
    .mode-tag.bubble { background: #00cec933; color: #00cec9; }
    .mode-tag.spinNetwork { background: #a29bfe33; color: #a29bfe; }
    .mode-tag.electroweak { background: #e1705533; color: #e17055; }
    .mode-tag.cosmic { background: #fd79a833; color: #fd79a8; }
    .mode-tag.nuclear { background: #00b89433; color: #00b894; }
    .mode-tag.topological { background: #6c5ce733; color: #6c5ce7; }

    /* Sliders Panel */
    .slider-group {
      margin-bottom: 15px;
    }

    .slider-label {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #888;
      margin-bottom: 5px;
    }

    .slider-value {
      color: #e0e0e0;
    }

    input[type="range"] {
      width: 100%;
      height: 4px;
      -webkit-appearance: none;
      background: #2a2a3a;
      border-radius: 2px;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      background: #6a6aaa;
      border-radius: 50%;
      cursor: pointer;
    }

    select {
      width: 100%;
      background: #2a2a3a;
      border: 1px solid #3a3a4a;
      color: #e0e0e0;
      padding: 8px;
      border-radius: 4px;
      font-family: inherit;
      font-size: 12px;
    }

    select[multiple] {
      height: auto;
      min-height: 80px;
    }

    select[multiple] option {
      padding: 4px 8px;
    }

    /* Toggle Switch */
    .toggle-group {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .toggle-label {
      font-size: 11px;
      color: #888;
    }

    .toggle {
      position: relative;
      width: 40px;
      height: 20px;
      background: #2a2a3a;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .toggle.active {
      background: #6a6aaa;
    }

    .toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      background: #e0e0e0;
      border-radius: 50%;
      transition: left 0.2s;
    }

    .toggle.active::after {
      left: 22px;
    }

    /* Dev Mode Banner */
    .dev-banner {
      background: linear-gradient(90deg, #6a4a6a33, transparent);
      border-left: 3px solid #aa6aaa;
      padding: 8px 12px;
      margin-bottom: 15px;
      font-size: 11px;
      color: #aa6aaa;
    }

    /* Rarity Curves */
    .rarity-chart {
      margin-bottom: 15px;
    }

    .rarity-chart-title {
      font-size: 11px;
      color: #888;
      margin-bottom: 8px;
    }

    .rarity-bars {
      display: flex;
      gap: 3px;
      height: 40px;
      align-items: flex-end;
    }

    .rarity-bar {
      flex: 1;
      background: #3a3a4a;
      border-radius: 2px 2px 0 0;
      position: relative;
      transition: all 0.3s;
    }

    .rarity-bar.active {
      background: #6a6aaa;
    }

    .rarity-bar-label {
      position: absolute;
      bottom: -18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 9px;
      color: #666;
      white-space: nowrap;
    }

    .rarity-bar.active .rarity-bar-label {
      color: #aaa;
    }

    /* Feedback Panel */
    .feedback-stats {
      font-size: 12px;
      color: #888;
      margin-top: 10px;
    }

    /* Keyboard hints */
    .keyboard-hints {
      display: flex;
      gap: 15px;
      font-size: 11px;
      color: #666;
      margin-top: 10px;
    }

    .key {
      display: inline-block;
      background: #2a2a3a;
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: 600;
      margin-right: 4px;
    }

    /* Version */
    .version {
      font-size: 10px;
      color: #444;
      text-align: center;
      margin-top: 10px;
    }

    /* Special features highlight */
    .special-feature {
      background: linear-gradient(90deg, #fa433320, transparent);
      border-left: 2px solid #fa4;
    }

    /* Section divider */
    .section-divider {
      border-top: 1px solid #2a2a3a;
      margin: 15px 0;
      padding-top: 15px;
    }

    .section-title {
      font-size: 10px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }

    /* Mode Checkboxes */
    .mode-checkboxes {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
    }

    .mode-checkbox {
      cursor: pointer;
    }

    .mode-checkbox input {
      display: none;
    }

    .mode-checkbox .mode-tag {
      opacity: 0.4;
      transition: opacity 0.2s;
    }

    .mode-checkbox input:checked + .mode-tag {
      opacity: 1;
    }

    .mode-checkbox:hover .mode-tag {
      opacity: 0.8;
    }

    .mode-buttons {
      display: flex;
      gap: 6px;
      margin-bottom: 15px;
    }

    .mode-buttons button {
      flex: 1;
      padding: 5px 10px;
      font-size: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-panel">
      <div id="sketch-holder"></div>

      <div class="controls">
        <button class="primary" onclick="window.regenerate()">Regenerate (R)</button>
        <button class="random" onclick="devRandom()">Dev Random</button>
        <button id="anim-btn" onclick="window.toggleAnimation()" title="Toggle particle flow animation">Animate (A)</button>
        <button onclick="saveCanvas('feynman-strings-' + hash.slice(2,10), 'png')">Save PNG (S)</button>
        <button class="like" onclick="like()">Like (L)</button>
        <button class="dislike" onclick="dislike()">Dislike (D)</button>
      </div>

      <div class="hash-display" id="hash-display"></div>

      <div class="keyboard-hints">
        <span><span class="key">R</span> Regenerate</span>
        <span><span class="key">S</span> Save</span>
        <span><span class="key">A</span> Animate</span>
        <span><span class="key">L</span> Like</span>
        <span><span class="key">D</span> Dislike</span>
      </div>
    </div>

    <div class="side-panel">
      <!-- Features Panel -->
      <div class="panel">
        <h2>Features</h2>
        <div class="features-table" id="features-table"></div>
      </div>

      <!-- Parameters Panel -->
      <div class="panel">
        <h2>
          Parameters
          <button onclick="resetParameters()">Reset</button>
        </h2>

        <div id="dev-banner" class="dev-banner" style="display: none;">
          DEV MODE: Uniform random distribution active
        </div>

        <!-- MODE CONTROLS -->
        <div class="section-title">Modes (select one or more)</div>

        <div class="mode-checkboxes" id="mode-checkboxes">
          <label class="mode-checkbox">
            <input type="checkbox" value="qed" checked>
            <span class="mode-tag qed">QED</span>
          </label>
          <label class="mode-checkbox">
            <input type="checkbox" value="qcd">
            <span class="mode-tag qcd">QCD</span>
          </label>
          <label class="mode-checkbox">
            <input type="checkbox" value="string">
            <span class="mode-tag string">STRING</span>
          </label>
          <label class="mode-checkbox">
            <input type="checkbox" value="vacuum">
            <span class="mode-tag vacuum">VACUUM</span>
          </label>
          <label class="mode-checkbox">
            <input type="checkbox" value="bubble">
            <span class="mode-tag bubble">BUBBLE</span>
          </label>
          <label class="mode-checkbox">
            <input type="checkbox" value="spinNetwork">
            <span class="mode-tag spinNetwork">SPINNET</span>
          </label>
          <label class="mode-checkbox">
            <input type="checkbox" value="electroweak">
            <span class="mode-tag electroweak">EWEAK</span>
          </label>
          <label class="mode-checkbox">
            <input type="checkbox" value="cosmic">
            <span class="mode-tag cosmic">COSMIC</span>
          </label>
          <label class="mode-checkbox">
            <input type="checkbox" value="nuclear">
            <span class="mode-tag nuclear">NUCLEAR</span>
          </label>
          <label class="mode-checkbox">
            <input type="checkbox" value="topological">
            <span class="mode-tag topological">TOPO</span>
          </label>
        </div>
        <div class="mode-buttons">
          <button onclick="selectAllModes()">All</button>
          <button onclick="clearModes()">Clear</button>
          <button onclick="resetModes()">Auto</button>
        </div>

        <div class="section-divider"></div>
        <div class="section-title">Visual Parameters</div>

        <div class="slider-group">
          <div class="slider-label">
            <span>Density</span>
            <span class="slider-value" id="density-value">1.0</span>
          </div>
          <input type="range" id="density-slider" min="0.2" max="4.0" step="0.1" value="1.0">
        </div>

        <div class="slider-group">
          <div class="slider-label">
            <span>Line Weight</span>
            <span class="slider-value" id="lineWeight-value">1.25</span>
          </div>
          <input type="range" id="lineWeight-slider" min="0.5" max="2.5" step="0.1" value="1.25">
        </div>

        <div class="slider-group">
          <div class="slider-label">
            <span>Loop Probability</span>
            <span class="slider-value" id="loopProb-value">0.5</span>
          </div>
          <input type="range" id="loopProb-slider" min="0" max="1.5" step="0.05" value="0.5">
        </div>

        <div class="slider-group">
          <div class="slider-label">
            <span>Connection Density</span>
            <span class="slider-value" id="connDensity-value">0.5</span>
          </div>
          <input type="range" id="connDensity-slider" min="0.1" max="1.0" step="0.05" value="0.5">
        </div>

        <div class="slider-group">
          <div class="slider-label">
            <span>Vertex Count</span>
            <span class="slider-value" id="vertexCount-value">12</span>
          </div>
          <input type="range" id="vertexCount-slider" min="3" max="50" step="1" value="12">
        </div>

        <div class="section-divider"></div>
        <div class="section-title">Style</div>

        <div class="slider-group">
          <div class="slider-label">
            <span>Style</span>
          </div>
          <select id="style-select">
            <option value="technical">Technical</option>
            <option value="geometric">Geometric (LeWitt)</option>
            <option value="artistic">Artistic</option>
            <option value="abstract">Abstract</option>
            <option value="chaotic">Chaotic</option>
            <option value="maximalist">Maximalist</option>
          </select>
        </div>

        <div class="slider-group">
          <div class="slider-label">
            <span>Palette</span>
          </div>
          <select id="palette-select">
            <optgroup label="Dark">
              <option value="blackboard">Blackboard</option>
              <option value="cosmic">Cosmic</option>
              <option value="void">Void</option>
              <option value="midnight">Midnight</option>
              <option value="matrix">Matrix</option>
            </optgroup>
            <optgroup label="Light">
              <option value="paper">Paper</option>
              <option value="parchment">Parchment</option>
              <option value="minimal">Minimal</option>
              <option value="lewitt">LeWitt B&W</option>
              <option value="lewittColor">LeWitt Color</option>
            </optgroup>
            <optgroup label="Colored">
              <option value="blueprint">Blueprint</option>
              <option value="infrared">Infrared</option>
              <option value="plasma">Plasma</option>
              <option value="quantum">Quantum</option>
            </optgroup>
          </select>
        </div>

        <div class="slider-group">
          <div class="slider-label">
            <span>Composition</span>
          </div>
          <select id="composition-select">
            <option value="centered">Centered</option>
            <option value="scattered">Scattered</option>
            <option value="flowing">Flowing</option>
            <option value="layered">Layered</option>
            <option value="grid">Grid (LeWitt)</option>
            <option value="radial">Radial</option>
            <option value="collision">Collision (LHC)</option>
            <option value="feynman">Feynman Diagram</option>
            <option value="detector">Detector</option>
            <option value="chalkboard">Chalkboard</option>
            <option value="symmetryBreaking">Symmetry Breaking</option>
            <option value="bilateral">Bilateral Symmetry</option>
            <option value="radial4">Radial 4-fold</option>
            <option value="radial6">Radial 6-fold</option>
            <option value="radial8">Radial 8-fold</option>
          </select>
        </div>

        <div class="slider-group">
          <div class="slider-label">
            <span>Background Pattern</span>
          </div>
          <select id="bgPattern-select">
            <option value="none">None</option>
            <optgroup label="Basic">
              <option value="grid">Grid</option>
              <option value="lines">Lines</option>
              <option value="dots">Dots</option>
              <option value="diagonal">Diagonal</option>
            </optgroup>
            <optgroup label="Sol LeWitt">
              <option value="arcs">Arcs</option>
              <option value="crosshatch">Crosshatch</option>
              <option value="concentric">Concentric Circles</option>
              <option value="concentricSquares">Concentric Squares</option>
              <option value="radialLines">Radial Lines</option>
              <option value="nestedArcs">Nested Arcs</option>
              <option value="allFour">All Four Directions</option>
            </optgroup>
            <optgroup label="Textural">
              <option value="wavyLines">Wavy Lines</option>
              <option value="bands">Bands</option>
              <option value="isometric">Isometric</option>
              <option value="randomArcs">Random Arcs</option>
            </optgroup>
          </select>
        </div>

        <div class="section-divider"></div>
        <div class="section-title">Toggles</div>

        <div class="toggle-group">
          <span class="toggle-label">Background Diagrams</span>
          <div class="toggle" id="bgDiagrams-toggle" onclick="toggleBgDiagrams()"></div>
        </div>

        <div class="toggle-group">
          <span class="toggle-label">Overlapping Layers</span>
          <div class="toggle" id="overlapping-toggle" onclick="toggleOverlapping()"></div>
        </div>

        <div class="section-divider"></div>
        <div class="section-title">Physics Enhancements</div>

        <div class="toggle-group">
          <span class="toggle-label">Particle Labels (γ, e⁻, μ...)</span>
          <div class="toggle" id="labels-toggle" onclick="toggleLabels()"></div>
        </div>

        <div class="toggle-group">
          <span class="toggle-label">Reaction Diagrams</span>
          <div class="toggle" id="reactions-toggle" onclick="toggleReactions()"></div>
        </div>

        <div class="toggle-group">
          <span class="toggle-label">Momentum Flow</span>
          <div class="toggle" id="momentum-toggle" onclick="toggleMomentum()"></div>
        </div>

        <div class="toggle-group">
          <span class="toggle-label">Color Charge Flow</span>
          <div class="toggle" id="colorflow-toggle" onclick="toggleColorFlow()"></div>
        </div>

        <div class="toggle-group">
          <span class="toggle-label">Vertex Glow</span>
          <div class="toggle" id="vertexglow-toggle" onclick="toggleVertexGlow()"></div>
        </div>
      </div>

      <!-- Rarity Curves Panel (hidden in dev mode) -->
      <div class="panel" id="rarity-panel">
        <h2>Rarity Curves</h2>
        <div id="rarity-curves"></div>
      </div>

      <!-- Feedback Panel -->
      <div class="panel">
        <h2>Feedback</h2>
        <div class="feedback-stats" id="feedback-stats">
          No feedback recorded yet
        </div>
        <button style="margin-top: 10px; width: 100%;" onclick="exportStats()">Export to Console</button>
      </div>

      <div class="version">Feynman Strings v1.8.0</div>
    </div>
  </div>

  <script src="sketch.js"></script>
  <script>
    let devMode = false;

    // Update displays after sketch loads
    window.addEventListener('load', () => {
      setTimeout(() => {
        updateFeaturesDisplay();
        updateRarityCurves();
        updateFeedbackStats();
        setupSliders();
        updateToggles();
        syncModeCheckboxes();
      }, 100);
    });

    // Expose UI update function for sketch.js to call
    window.updateUI = function() {
      updateFeaturesDisplay();
      updateRarityCurves();
      updateToggles();
      syncModeCheckboxes();
    };

    function updateFeaturesDisplay() {
      const features = window.getFeatures();
      const table = document.getElementById('features-table');
      const hashDisplay = document.getElementById('hash-display');

      hashDisplay.textContent = window.getHash();

      let html = '';

      // Modes
      html += `<div class="feature-row">
        <span class="feature-name">Modes</span>
        <span class="feature-value">
          ${features.modes.map(m => `<span class="mode-tag ${m}">${m.toUpperCase()}</span>`).join('')}
        </span>
      </div>`;

      // Mode blend
      const blendRarity = features.modeBlend === 'chaos' ? 'legendary' :
                         features.modeBlend === 'triple' ? 'rare' :
                         features.modeBlend === 'dual' ? 'uncommon' : 'common';
      html += `<div class="feature-row">
        <span class="feature-name">Blend</span>
        <span class="feature-value">
          <span class="rarity-badge rarity-${blendRarity}">${features.modeBlend}</span>
        </span>
      </div>`;

      // Density
      const densityRarity = features.densityName === 'chaotic' ? 'legendary' :
                           features.densityName === 'dense' ? 'rare' :
                           features.densityName === 'minimal' ? 'uncommon' : 'common';
      html += `<div class="feature-row">
        <span class="feature-name">Density</span>
        <span class="feature-value">
          <span class="rarity-badge rarity-${densityRarity}">${features.densityName}</span>
          <small>(${features.density.toFixed(2)})</small>
        </span>
      </div>`;

      // Style
      const styleRarity = features.style === 'chaotic' ? 'rare' :
                         features.style === 'maximalist' ? 'rare' : 'common';
      html += `<div class="feature-row">
        <span class="feature-name">Style</span>
        <span class="feature-value">
          <span class="rarity-badge rarity-${styleRarity}">${features.style}</span>
        </span>
      </div>`;

      // Composition
      html += `<div class="feature-row">
        <span class="feature-name">Composition</span>
        <span class="feature-value">${features.composition}</span>
      </div>`;

      // Palette
      html += `<div class="feature-row">
        <span class="feature-name">Palette</span>
        <span class="feature-value">${features.palette}</span>
      </div>`;

      // Vertex count
      html += `<div class="feature-row">
        <span class="feature-name">Vertices</span>
        <span class="feature-value">${features.vertexCount}</span>
      </div>`;

      // Special features
      if (features.hasHiggs) {
        html += `<div class="feature-row special-feature">
          <span class="feature-name">Special</span>
          <span class="feature-value">
            <span class="rarity-badge rarity-legendary">Higgs</span>
          </span>
        </div>`;
      }
      if (features.hasCalabiYau) {
        html += `<div class="feature-row special-feature">
          <span class="feature-name">Special</span>
          <span class="feature-value">
            <span class="rarity-badge rarity-legendary">Calabi-Yau</span>
          </span>
        </div>`;
      }
      if (features.hasGraviton) {
        html += `<div class="feature-row special-feature">
          <span class="feature-name">Special</span>
          <span class="feature-value">
            <span class="rarity-badge rarity-legendary">Graviton</span>
          </span>
        </div>`;
      }
      if (features.hasSupersymmetry) {
        html += `<div class="feature-row special-feature">
          <span class="feature-name">Special</span>
          <span class="feature-value">
            <span class="rarity-badge rarity-legendary">SUSY</span>
          </span>
        </div>`;
      }

      // Physics enhancements
      const enhancements = [];
      if (features.showLabels) enhancements.push('Labels');
      if (features.showReactions) enhancements.push('Reactions');
      if (features.showMomentumFlow) enhancements.push('Momentum');
      if (features.showColorFlow) enhancements.push('Color Flow');
      if (features.showVertexGlow) enhancements.push('Glow');
      if (enhancements.length > 0) {
        html += `<div class="feature-row">
          <span class="feature-name">Enhancements</span>
          <span class="feature-value"><small>${enhancements.join(', ')}</small></span>
        </div>`;
      }

      // Show background pattern and symmetry
      if (features.backgroundPattern && features.backgroundPattern !== "none") {
        html += `<div class="feature-row">
          <span class="feature-name">Pattern</span>
          <span class="feature-value">${features.backgroundPattern}</span>
        </div>`;
      }
      table.innerHTML = html;

      // Update slider values
      document.getElementById('density-slider').value = features.density;
      document.getElementById('density-value').textContent = features.density.toFixed(2);
      document.getElementById('lineWeight-slider').value = features.lineWeight;
      document.getElementById('lineWeight-value').textContent = features.lineWeight.toFixed(1);
      document.getElementById('loopProb-slider').value = features.loopProbability;
      document.getElementById('loopProb-value').textContent = features.loopProbability.toFixed(2);
      document.getElementById('connDensity-slider').value = features.connectionDensity || 0.5;
      document.getElementById('connDensity-value').textContent = (features.connectionDensity || 0.5).toFixed(2);
      document.getElementById('vertexCount-slider').value = features.vertexCount;
      document.getElementById('vertexCount-value').textContent = features.vertexCount;

      // Update selects
      document.getElementById('style-select').value = features.style;
      document.getElementById('palette-select').value = features.palette;
      document.getElementById('composition-select').value = features.composition;
      document.getElementById('bgPattern-select').value = features.backgroundPattern || 'none';
    }

    function updateToggles() {
      const features = window.getFeatures();

      const bgDiagramsToggle = document.getElementById('bgDiagrams-toggle');
      const overlappingToggle = document.getElementById('overlapping-toggle');

      bgDiagramsToggle.classList.toggle('active', features.hasBackgroundDiagrams);
      overlappingToggle.classList.toggle('active', features.hasOverlappingLayers);

      // Physics enhancement toggles
      document.getElementById('labels-toggle').classList.toggle('active', !!features.showLabels);
      document.getElementById('reactions-toggle').classList.toggle('active', !!features.showReactions);
      document.getElementById('momentum-toggle').classList.toggle('active', !!features.showMomentumFlow);
      document.getElementById('colorflow-toggle').classList.toggle('active', !!features.showColorFlow);
      document.getElementById('vertexglow-toggle').classList.toggle('active', !!features.showVertexGlow);
    }

    function toggleBgDiagrams() {
      const toggle = document.getElementById('bgDiagrams-toggle');
      const isActive = toggle.classList.toggle('active');
      window.setParameter('hasBackgroundDiagrams', isActive);
      window.render();
    }

    function toggleOverlapping() {
      const toggle = document.getElementById('overlapping-toggle');
      const isActive = toggle.classList.toggle('active');
      window.setParameter('hasOverlappingLayers', isActive);
      window.render();
    }

    function toggleLabels() {
      const toggle = document.getElementById('labels-toggle');
      const isActive = toggle.classList.toggle('active');
      window.setParameter('showLabels', isActive);
      window.render();
    }

    function toggleReactions() {
      const toggle = document.getElementById('reactions-toggle');
      const isActive = toggle.classList.toggle('active');
      window.setParameter('showReactions', isActive);
      window.render();
    }

    function toggleMomentum() {
      const toggle = document.getElementById('momentum-toggle');
      const isActive = toggle.classList.toggle('active');
      window.setParameter('showMomentumFlow', isActive);
      window.render();
    }

    function toggleColorFlow() {
      const toggle = document.getElementById('colorflow-toggle');
      const isActive = toggle.classList.toggle('active');
      window.setParameter('showColorFlow', isActive);
      window.render();
    }

    function toggleVertexGlow() {
      const toggle = document.getElementById('vertexglow-toggle');
      const isActive = toggle.classList.toggle('active');
      window.setParameter('showVertexGlow', isActive);
      window.render();
    }

    window.updateAnimationButton = function() {
      const btn = document.getElementById('anim-btn');
      if (btn) {
        btn.style.background = window.isAnimating() ? '#4a6a4a' : '#2a2a3a';
        btn.style.borderColor = window.isAnimating() ? '#6aaa6a' : '#3a3a4a';
      }
    };

    function updateRarityCurves() {
      if (devMode) {
        document.getElementById('rarity-panel').style.display = 'none';
        return;
      }
      document.getElementById('rarity-panel').style.display = 'block';

      const curves = window.getRarityCurves();
      const features = window.getFeatures();
      const container = document.getElementById('rarity-curves');

      let html = '';

      for (const [key, curve] of Object.entries(curves)) {
        const currentValue = features[key] || features[key + 'Name'];

        html += `<div class="rarity-chart">
          <div class="rarity-chart-title">${key}</div>
          <div class="rarity-bars">`;

        const maxProb = Math.max(...curve.probabilities);

        curve.labels.forEach((label, i) => {
          const height = (curve.probabilities[i] / maxProb) * 100;
          const isActive = label === currentValue;

          html += `<div class="rarity-bar ${isActive ? 'active' : ''}" style="height: ${height}%">
            <span class="rarity-bar-label">${label}</span>
          </div>`;
        });

        html += `</div></div>`;
      }

      container.innerHTML = html;
    }

    function updateFeedbackStats() {
      const stats = window.getFeedbackStats();
      const container = document.getElementById('feedback-stats');

      if (stats.totalLiked === 0 && stats.totalDisliked === 0) {
        container.textContent = 'No feedback recorded yet';
        return;
      }

      container.innerHTML = `
        Liked: ${stats.totalLiked} | Disliked: ${stats.totalDisliked}<br>
        <small>Check console for detailed stats</small>
      `;
    }

    function setupSliders() {
      // Mode checkboxes
      document.querySelectorAll('#mode-checkboxes input').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          updateModesFromCheckboxes();
        });
      });

      // Density slider
      document.getElementById('density-slider').addEventListener('input', (e) => {
        const val = parseFloat(e.target.value);
        document.getElementById('density-value').textContent = val.toFixed(2);
        window.setParameter('density', val);
        window.render();
      });

      // Line weight slider
      document.getElementById('lineWeight-slider').addEventListener('input', (e) => {
        const val = parseFloat(e.target.value);
        document.getElementById('lineWeight-value').textContent = val.toFixed(1);
        window.setParameter('lineWeight', val);
        window.render();
      });

      // Loop probability slider
      document.getElementById('loopProb-slider').addEventListener('input', (e) => {
        const val = parseFloat(e.target.value);
        document.getElementById('loopProb-value').textContent = val.toFixed(2);
        window.setParameter('loopProbability', val);
        window.render();
      });

      // Connection density slider
      document.getElementById('connDensity-slider').addEventListener('input', (e) => {
        const val = parseFloat(e.target.value);
        document.getElementById('connDensity-value').textContent = val.toFixed(2);
        window.setParameter('connectionDensity', val);
        window.render();
      });

      // Vertex count slider
      document.getElementById('vertexCount-slider').addEventListener('input', (e) => {
        const val = parseInt(e.target.value);
        document.getElementById('vertexCount-value').textContent = val;
        window.setParameter('vertexCount', val);
        window.render();
      });

      // Style select
      document.getElementById('style-select').addEventListener('change', (e) => {
        window.setParameter('style', e.target.value);
        window.render();
      });

      // Palette select
      document.getElementById('palette-select').addEventListener('change', (e) => {
        window.setParameter('palette', e.target.value);
        window.render();
      });

      // Composition select
      document.getElementById('composition-select').addEventListener('change', (e) => {
        window.setParameter('composition', e.target.value);
        window.render();
      });

      // Background pattern select
      document.getElementById('bgPattern-select').addEventListener('change', (e) => {
        window.setParameter('backgroundPattern', e.target.value);
        window.render();
      });

    }

    function getRandomMode(exclude = []) {
      const allModes = ['qed', 'qcd', 'string', 'vacuum', 'bubble', 'spinNetwork', 'electroweak', 'cosmic', 'nuclear', 'topological'];
      const available = allModes.filter(m => !exclude.includes(m));
      return available[Math.floor(Math.random() * available.length)];
    }

    // Mode checkbox helpers
    function updateModesFromCheckboxes() {
      const checkboxes = document.querySelectorAll('#mode-checkboxes input:checked');
      const modes = Array.from(checkboxes).map(cb => cb.value);

      if (modes.length === 0) {
        // Don't allow empty - default to qed
        document.querySelector('#mode-checkboxes input[value="qed"]').checked = true;
        modes.push('qed');
      }

      window.setParameter('modes', modes);
      window.setParameter('modeBlend', modes.length === 1 ? 'single' :
                                       modes.length === 2 ? 'dual' :
                                       modes.length === 3 ? 'triple' : 'chaos');
      window.render();
      updateFeaturesDisplay();
    }

    function selectAllModes() {
      document.querySelectorAll('#mode-checkboxes input').forEach(cb => cb.checked = true);
      updateModesFromCheckboxes();
    }

    function clearModes() {
      document.querySelectorAll('#mode-checkboxes input').forEach(cb => cb.checked = false);
      document.querySelector('#mode-checkboxes input[value="qed"]').checked = true;
      updateModesFromCheckboxes();
    }

    function resetModes() {
      window.resetToOriginal();
      window.render();
      updateFeaturesDisplay();
      syncModeCheckboxes();
    }

    function syncModeCheckboxes() {
      const features = window.getFeatures();
      document.querySelectorAll('#mode-checkboxes input').forEach(cb => {
        cb.checked = features.modes.includes(cb.value);
      });
    }

    function resetParameters() {
      devMode = false;
      document.getElementById('dev-banner').style.display = 'none';
      window.resetToOriginal();
      window.render();
      updateFeaturesDisplay();
      updateRarityCurves();
      updateToggles();
      syncModeCheckboxes();
    }

    // Dev Random - uniform distribution across all options
    function devRandom() {
      devMode = true;
      document.getElementById('dev-banner').style.display = 'block';
      document.getElementById('rarity-panel').style.display = 'none';

      const allModes = ['qed', 'qcd', 'string', 'vacuum', 'bubble', 'spinNetwork', 'electroweak', 'cosmic', 'nuclear', 'topological'];
      const allStyles = ['technical', 'geometric', 'artistic', 'abstract', 'chaotic', 'maximalist'];
      const allPalettes = ['blackboard', 'cosmic', 'void', 'midnight', 'matrix', 'paper', 'parchment', 'minimal', 'lewitt', 'lewittColor', 'blueprint', 'infrared', 'plasma', 'quantum'];
      const allCompositions = ['centered', 'scattered', 'flowing', 'layered', 'grid', 'radial', 'collision', 'feynman', 'detector', 'chalkboard', 'symmetryBreaking', 'bilateral', 'radial4', 'radial6', 'radial8'];
      const allPatterns = ['none', 'grid', 'lines', 'dots', 'arcs', 'diagonal', 'crosshatch', 'concentric', 'concentricSquares', 'radialLines', 'wavyLines', 'bands', 'isometric', 'randomArcs', 'nestedArcs', 'allFour'];
      const allBlends = ['single', 'dual', 'triple', 'chaos'];

      // Random blend type
      const modeBlend = allBlends[Math.floor(Math.random() * allBlends.length)];

      // Random modes based on blend
      let modes;
      if (modeBlend === 'single') {
        modes = [allModes[Math.floor(Math.random() * allModes.length)]];
      } else if (modeBlend === 'dual') {
        const shuffled = [...allModes].sort(() => Math.random() - 0.5);
        modes = shuffled.slice(0, 2);
      } else if (modeBlend === 'triple') {
        const shuffled = [...allModes].sort(() => Math.random() - 0.5);
        modes = shuffled.slice(0, 3);
      } else {
        modes = [...allModes];
      }

      // Set all random parameters
      window.setParameter('modes', modes);
      window.setParameter('modeBlend', modeBlend);
      window.setParameter('style', allStyles[Math.floor(Math.random() * allStyles.length)]);
      window.setParameter('palette', allPalettes[Math.floor(Math.random() * allPalettes.length)]);
      window.setParameter('composition', allCompositions[Math.floor(Math.random() * allCompositions.length)]);
      window.setParameter('backgroundPattern', allPatterns[Math.floor(Math.random() * allPatterns.length)]);
      window.setParameter('density', 0.3 + Math.random() * 3.5);
      window.setParameter('lineWeight', 0.5 + Math.random() * 2.0);  // Lower range for cleaner look
      window.setParameter('loopProbability', Math.random() * 1.5);
      window.setParameter('connectionDensity', 0.1 + Math.random() * 0.9);
      window.setParameter('vertexCount', 3 + Math.floor(Math.random() * 47));
      window.setParameter('hasBackgroundDiagrams', Math.random() > 0.5);
      window.setParameter('hasOverlappingLayers', Math.random() > 0.5);

      // Random special features (higher probability in dev mode)
      window.setParameter('hasHiggs', Math.random() > 0.7);
      window.setParameter('hasCalabiYau', Math.random() > 0.7);
      window.setParameter('hasGraviton', Math.random() > 0.8);
      window.setParameter('hasSupersymmetry', Math.random() > 0.75);

      // Physics enhancements (higher probability in dev mode)
      window.setParameter('showLabels', Math.random() > 0.4);
      window.setParameter('showReactions', Math.random() > 0.4);
      window.setParameter('showMomentumFlow', Math.random() > 0.5);
      window.setParameter('showColorFlow', Math.random() > 0.5);
      window.setParameter('showVertexGlow', Math.random() > 0.4);

      window.render();
      updateFeaturesDisplay();
      updateToggles();
      syncModeCheckboxes();
    }

    function like() {
      window.recordFeedback(true);
      updateFeedbackStats();
    }

    function dislike() {
      window.recordFeedback(false);
      updateFeedbackStats();
    }

    function exportStats() {
      console.log('=== Feynman Strings Feedback ===');
      console.log(JSON.stringify(window.exportFeedback(), null, 2));
      console.log('=== Stats Summary ===');
      console.log(window.getFeedbackStats());
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'l' || e.key === 'L') like();
      if (e.key === 'd' || e.key === 'D') dislike();
    });
  </script>
</body>
</html>
