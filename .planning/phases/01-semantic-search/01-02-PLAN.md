---
phase: 01-semantic-search
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - services/embeddings/search.js
  - services/embeddings/index.js
  - scripts/search-cli.js
  - processed/embeddings/checksums.json
autonomous: true

must_haves:
  truths:
    - "User can search projects by natural language query"
    - "Search returns relevant results ranked by similarity"
    - "Results include visual preview link, technique tags, code snippet, artist + stats"
    - "Multiple output formats work (JSON, table, markdown)"
    - "Filters narrow results by platform, framework, artist"
  artifacts:
    - path: "services/embeddings/search.js"
      provides: "Search logic with filtering and ranking"
      exports: ["search", "searchWithFilters"]
    - path: "services/embeddings/index.js"
      provides: "Main exports for embedding service"
      exports: ["search", "embed", "EmbeddingModel", "loadIndex"]
    - path: "scripts/search-cli.js"
      provides: "CLI interface for semantic search"
      min_lines: 120
  key_links:
    - from: "scripts/search-cli.js"
      to: "services/embeddings/search.js"
      via: "import search"
      pattern: "import.*search.*from.*embeddings"
    - from: "services/embeddings/search.js"
      to: "services/embeddings/model.js"
      via: "embed query"
      pattern: "embed\\(query\\)"
    - from: "services/embeddings/search.js"
      to: "processed/embeddings/vectors.json"
      via: "loadIndex"
      pattern: "loadIndex\\(\\)"
---

<objective>
Build the search CLI and API for semantic search.

Purpose: Enable natural language queries across the 28k+ project knowledge base. Support creative intent queries like "moody gradients with organic movement" and technique queries like "flow fields with particles".

Output: Fully functional search CLI with multiple output formats, filtering, and programmatic API.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-semantic-search/01-CONTEXT.md
@.planning/phases/01-semantic-search/01-RESEARCH.md

# Depends on Plan 01 outputs
@.planning/phases/01-semantic-search/01-01-SUMMARY.md

# Reference for result structure
@processed/rag-documents.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create search service with filtering</name>
  <files>
    services/embeddings/search.js
    services/embeddings/index.js
  </files>
  <action>
    1. Create services/embeddings/search.js:
       - Import model.js for embedding queries
       - Import storage.js for loading index
       - cosineSimilarity(a, b) - dot product (vectors pre-normalized)
       - search(query, options) async function:
         - Options: { topK: 10, filters: {}, includeScores: true }
         - Embed query using model.embed()
         - Score all vectors against query embedding
         - Apply filters before sorting:
           - filters.platform: 'artblocks' | 'fxhash'
           - filters.framework: 'p5js' | 'threejs' | 'js' | 'regl' | 'tone'
           - filters.artist: string (case-insensitive partial match)
           - filters.minScore: number (default 0.3)
         - Sort by score descending
         - Return top K results with: { projectId, type, score, source, artist, scriptType }
       - searchWithFilters(query, filters) - convenience wrapper

    2. Create services/embeddings/index.js as main export:
       - Re-export from model.js: EmbeddingModel, embed, embedBatch
       - Re-export from search.js: search, searchWithFilters
       - Re-export from storage.js: loadIndex, indexExists
       - Export VERSION constant for API compatibility

    Reference 01-RESEARCH.md Pattern 3 for search implementation.
  </action>
  <verify>
    Test search: `node -e "import('./services/embeddings/search.js').then(async s => { const r = await s.search('flow fields with particles', { topK: 5 }); console.log(r.map(x => x.projectId + ': ' + x.score.toFixed(3))) })"`
    Should return 5 results with similarity scores
  </verify>
  <done>
    - search.js implements cosine similarity search
    - Filters work for platform, framework, artist
    - Results include projectId, score, metadata
    - index.js exports unified API
  </done>
</task>

<task type="auto">
  <name>Task 2: Create search CLI with multiple output formats</name>
  <files>
    scripts/search-cli.js
    package.json
  </files>
  <action>
    1. Create scripts/search-cli.js:
       - Parse CLI arguments:
         - Positional: query string (can be quoted)
         - --top, -n: number of results (default 10)
         - --format, -f: json | table | markdown (default table)
         - --platform: artblocks | fxhash
         - --framework: p5js | threejs | js | regl | tone
         - --artist: filter by artist name
         - --include-local: include local sketches (future, stub for now)
         - --verbose, -v: show debug info

       2. Output formats:
          - table: ASCII table with columns: Rank, Score, Project, Artist, Framework, Platform
          - json: Array of result objects (for piping/scripting)
          - markdown: Formatted for docs, includes links

       3. Enrich results with full project data:
          - Load rag-documents.json to get full content
          - Include snippet of description (first 100 chars)
          - Include link to original:
            - Art Blocks: https://artblocks.io/collections/curated/projects/{projectId}
            - fxhash: https://www.fxhash.xyz/generative/{projectId}
          - Include key aesthetics/tags

       4. Add to package.json scripts:
          "search": "node scripts/search-cli.js"

       5. Show helpful usage when no query provided

    Example invocations:
    - `npm run search "moody gradients"`
    - `npm run search -- --format json "particle systems"`
    - `npm run search -- -n 20 --framework p5js "recursive patterns"`
  </action>
  <verify>
    Basic: `node scripts/search-cli.js "flow fields"`
    Should show table with 10 results

    JSON: `node scripts/search-cli.js --format json "noise patterns" | head -20`
    Should output valid JSON array

    Filtered: `node scripts/search-cli.js --framework p5js --top 5 "generative grid"`
    Should show only p5js projects

    Help: `node scripts/search-cli.js`
    Should show usage information
  </verify>
  <done>
    - CLI parses all flags correctly
    - Table output is readable in terminal
    - JSON output is valid and parseable
    - Markdown output includes links
    - Filters narrow results as expected
    - npm run search works
  </done>
</task>

<task type="auto">
  <name>Task 3: Add incremental update support and wire up existing assistant</name>
  <files>
    services/embeddings/storage.js
    services/embeddings/generate.js
    scripts/art-assistant.js
  </files>
  <action>
    1. Enhance storage.js with checksum tracking:
       - CHECKSUMS_PATH = './processed/embeddings/checksums.json'
       - generateChecksum(project) - MD5 of name|description|script_length
       - loadChecksums() / saveChecksums()
       - getChangedProjects(projects, checksums) - returns projects needing re-embedding

    2. Update generate.js for incremental updates:
       - Load existing checksums if available
       - Skip projects that haven't changed
       - Output: "X projects need embedding (Y cached)"
       - Add --full flag to force complete regeneration
       - Default behavior: incremental (much faster for updates)

    3. Update scripts/art-assistant.js to use semantic search:
       - Replace SimpleRetriever TF-IDF with embedding search
       - Import search from services/embeddings/index.js
       - Use top 5 semantic search results as context
       - Keep Claude API integration unchanged
       - Fallback gracefully if embeddings don't exist (with helpful error)

    This enables the existing `node scripts/art-assistant.js "query"` to use semantic search.
  </action>
  <verify>
    Incremental: `node services/embeddings/generate.js` (second run)
    Should complete in seconds saying "0 projects need embedding (28338 cached)"

    Assistant: `node scripts/art-assistant.js "How do flow fields work?"` (requires ANTHROPIC_API_KEY)
    Should use semantic search results as context for Claude

    Fallback: Move embeddings, run assistant, should show helpful error message
  </verify>
  <done>
    - Checksums track project state for incremental updates
    - Second generate run is fast (uses cache)
    - art-assistant.js uses semantic search
    - Graceful fallback when embeddings missing
  </done>
</task>

</tasks>

<verification>
1. `node scripts/search-cli.js "organic flowing shapes"` returns relevant results
2. `node scripts/search-cli.js --format json "noise" | node -e "console.log(JSON.parse(require('fs').readFileSync(0,'utf8')).length)"` outputs a number
3. `node scripts/search-cli.js --framework threejs "3d"` shows only Three.js projects
4. `npm run search -- "minimalist geometric"` works from package.json
5. Search latency is sub-second after initial index load
</verification>

<success_criteria>
1. User can search with natural language: `npm run search "moody gradients with organic movement"`
2. Results ranked by semantic similarity (top results are genuinely relevant)
3. Multiple output formats: JSON for scripts, table for humans, markdown for docs
4. Filters work: platform, framework, artist
5. Incremental updates skip unchanged projects
6. Existing art-assistant.js uses semantic search as retrieval backend
7. Search works offline (no external API calls during search)
</success_criteria>

<output>
After completion, create `.planning/phases/01-semantic-search/01-02-SUMMARY.md`
</output>
