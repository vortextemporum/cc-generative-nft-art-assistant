---
phase: 02-developer-tools
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - services/renderer/render.js
  - services/renderer/analyze.js
  - services/renderer/compare.js
  - services/renderer/index.js
  - package.json
autonomous: true

must_haves:
  truths:
    - "Renderer captures screenshots of sketches"
    - "Analysis extracts color distribution and composition metrics"
    - "Batch processing handles multiple sketches efficiently"
    - "Output is structured for Claude Code consumption"
  artifacts:
    - path: "services/renderer/render.js"
      provides: "Core renderer with ESM exports"
      exports: ["SketchRenderer", "captureSketch"]
    - path: "services/renderer/analyze.js"
      provides: "Visual analysis extraction"
      exports: ["analyzeCanvas", "formatAnalysis"]
    - path: "services/renderer/index.js"
      provides: "Unified exports"
      exports: ["SketchRenderer", "captureSketch", "analyzeSketch", "batchCapture"]
  key_links:
    - from: "services/renderer/analyze.js"
      to: "services/renderer/render.js"
      via: "import for page access"
      pattern: "import.*from.*render"
    - from: "services/renderer/index.js"
      to: "services/renderer/render.js"
      via: "re-export"
      pattern: "export.*from.*render"
---

<objective>
Enhance visual renderer with structured analysis output for Claude Code integration

Purpose: Enable Claude Code to capture sketches and receive structured visual analysis (color, composition, density) that supports the iteration workflow from CONTEXT.md: "user tweaks -> renders -> looks -> tweaks again"

Output: ESM renderer module with structured analysis output, batch processing, and Claude-readable metrics
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-developer-tools/02-CONTEXT.md
@.planning/phases/02-developer-tools/02-RESEARCH.md

# Existing code to update
@services/renderer/render.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert renderer to ESM and refactor structure</name>
  <files>
    services/renderer/render.js
    services/renderer/index.js
  </files>
  <action>
1. Convert services/renderer/render.js from CommonJS to ESM:
   - Replace const fs = require('fs') with import fs from 'fs'
   - Replace const path = require('path') with import path from 'path'
   - Replace module.exports with export statements
   - Add import { fileURLToPath } from 'url' for __dirname equivalent
   - Replace if (require.main === module) with proper ESM main detection

2. Keep SketchRenderer class largely as-is but ensure exports are ESM:
   - export class SketchRenderer
   - export async function captureSketch(sketchPath, options)
   - export async function batchCapture(sketchesDir, outputDir, options)

3. Create services/renderer/index.js as unified export point:
   - Re-export from render.js
   - Re-export from analyze.js (created in Task 2)
   - Export VERSION constant

4. Ensure CLI still works:
   - Move CLI logic to bottom of render.js
   - Use: if (import.meta.url === `file://${process.argv[1]}`)

Key changes to existing analyze() method:
   - Move color extraction logic to separate analyze.js module
   - Keep analyze() as thin wrapper that calls analyzeCanvas()
  </action>
  <verify>
    node --experimental-vm-modules services/renderer/render.js --help 2>/dev/null || node services/renderer/render.js 2>&1 | head -20
  </verify>
  <done>
    Renderer converted to ESM, exports working, CLI still functional
  </done>
</task>

<task type="auto">
  <name>Task 2: Create structured analysis module</name>
  <files>
    services/renderer/analyze.js
  </files>
  <action>
1. Create services/renderer/analyze.js with structured analysis output:

   export async function analyzeCanvas(page) - Extract from page.evaluate():
   - Color histogram with quantization (existing logic)
   - Dominant colors (top 10, with RGB and percentage)
   - Hue distribution analysis
   - Brightness and saturation averages
   - Color diversity metric (how many hue ranges used)
   - Flags: isMonochrome, isDark, isLight, isPastel, isVibrant

   Add new composition analysis:
   - analyzeDistribution(imageData): 'centered' | 'edge-heavy' | 'uniform' | 'corner-weighted'
     Method: Divide canvas into 3x3 grid, count pixels in each cell, compare ratios
   - analyzeDensity(imageData): 'sparse' | 'moderate' | 'dense'
     Method: Count non-background pixels vs total pixels

2. export function formatAnalysis(canvasData, screenshotPath):
   Return Claude-readable structure:
   {
     metrics: {
       colors: { dominant: [...], diversity: N, avgBrightness, avgSaturation },
       flags: { monochrome, dark, light, pastel, vibrant, highContrast }
     },
     composition: {
       distribution: 'centered' | 'edge-heavy' | 'uniform' | 'corner-weighted',
       density: 'sparse' | 'moderate' | 'dense',
       gridWeights: [9 numbers for 3x3 grid]
     },
     screenshotPath: string,
     interpretation: {
       // Human-readable summary for Claude
       colorDescription: "High saturation, warm palette with orange and red dominance",
       compositionDescription: "Center-weighted composition with moderate density"
     }
   }

3. Generate interpretation strings algorithmically:
   - colorDescription: Based on saturation, brightness, dominant hues
   - compositionDescription: Based on distribution and density
   These help Claude understand the visual without seeing it
  </action>
  <verify>
    node -c services/renderer/analyze.js
  </verify>
  <done>
    Analysis module with structured output, composition detection, and interpretation strings
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire analysis into renderer and update CLI</name>
  <files>
    services/renderer/render.js
    services/renderer/index.js
    package.json
  </files>
  <action>
1. Update render.js analyze() method:
   - Import { analyzeCanvas, formatAnalysis } from './analyze.js'
   - Replace inline page.evaluate() with analyzeCanvas(page)
   - Use formatAnalysis() to structure output
   - Return structured analysis with screenshot buffer

2. Add new CLI command 'analyze-json':
   - Like 'analyze' but outputs only the structured JSON (no screenshot)
   - Useful for piping to other tools

3. Enhance 'batch' command:
   - Add --analyze flag to output analysis JSON alongside screenshots
   - Create {sketch}-analysis.json for each sketch when flag set

4. Update services/renderer/index.js to export:
   - SketchRenderer class
   - captureSketch function
   - analyzeSketch function (new, returns structured analysis)
   - batchCapture function
   - analyzeCanvas, formatAnalysis from analyze.js

5. Update root package.json scripts:
   - "render:capture": "node services/renderer/render.js capture"
   - "render:analyze": "node services/renderer/render.js analyze"
   - "render:batch": "node services/renderer/render.js batch"
   - "render:variations": "node services/renderer/render.js variations"
  </action>
  <verify>
    cd /Users/berk/Downloads/generative-art-assistant && node services/renderer/render.js analyze sketches/molecular-watercolor 2>/dev/null | head -50 || echo "Test sketch not available - syntax check passed"
  </verify>
  <done>
    Analysis wired into renderer, CLI updated with new commands, npm scripts added
  </done>
</task>

</tasks>

<verification>
1. node services/renderer/render.js (no args) shows help text
2. node -c services/renderer/index.js passes syntax check
3. Exports from index.js include: SketchRenderer, captureSketch, analyzeSketch, analyzeCanvas, formatAnalysis
4. analyze command outputs structured JSON with metrics, composition, interpretation
5. No CommonJS require() statements remain in renderer modules
</verification>

<success_criteria>
- Renderer converted to ESM
- analyze.js provides structured output with:
  - Color metrics (dominant, diversity, brightness, saturation)
  - Composition metrics (distribution, density)
  - Interpretation strings for Claude
- CLI supports analyze, analyze-json, and batch --analyze
- Package.json has render:* scripts
</success_criteria>

<output>
After completion, create `.planning/phases/02-developer-tools/02-02-SUMMARY.md`
</output>
